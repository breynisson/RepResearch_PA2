# Severe weather events on population health and economics.

## Synopsis

## Data Processing

The data is read and we use the str() to take a peek at the data:

```{r, cache=TRUE}
data<-read.csv("repdata-data-StormData.csv.bz2")
str(data)
```

We start off by converting the BGN_DATE column data to date-type. We also discard the time data in this column:

```{r}
data$BGN_DATE<-as.Date(as.character(data$BGN_DATE), "%m/%d/%Y")
```

And check that the converstion is OK:
```{r}
str(data$BGN_DATE)
```

## Analysis

### Fatalities and Injuries. Summary statistics for the United States.
We take a look at what timeframe we are investigating. 

The first date is
```{r}
min(data$BGN_DATE)
```

while the last date in the dataset is 
```{r}
max(data$BGN_DATE)
```

We want to find out what are the most harmful weather effects to the population in the United States over the whole timeframe in question. To this end, we will look at fatalities and injuries. We will investigate these seperatly. We order the dataset based on the fatalities and injuries.

```{r}
library(plyr)
fatalities<-count(data, vars = "EVTYPE", wt_var = "FATALITIES")
fatalities<-fatalities[order(-fatalities$freq),]

injuries<-count(data, vars = "EVTYPE", wt_var = "INJURIES")
injuries<-injuries[order(-injuries$freq),]
```

And then reduce the data to the top 10 causes:
```{r}
fatalities<-fatalities[1:10,]
fatalities

injuries<-injuries[1:10,]
injuries
```


From the two tables, we see that in the time period from `r min(data$BGN_DATE)` to `r max(data$BGN_DATE)`, Tornados are the most harmful weather events to public health.

### Fatalities and Injuries. State-by-state analysis.

We would like to analyze the fatalities and injuries caused by weather in each state.

```{r}
fatalities_by_state_tmp<-data[order(data$STATE, -data$FATALITIES),]
injuries_by_state_tmp<-data[order(data$STATE, -data$INJURIES),]
```

We trim the data to just the STATE, EVTYPE and FATALITIES or INJURIES variables.

```{r}
fatalities_by_state<-fatalities_by_state_tmp[,c("STATE", "EVTYPE", "FATALITIES")]
injuries_by_state<-injuries_by_state_tmp[,c("STATE", "EVTYPE", "INJURIES")]
```

Then sum the datasets by state:

```{r}
fatalities_by_state_s<-ddply(fatalities_by_state, .(STATE, EVTYPE), 
                             summarize, FATALITIES=sum(FATALITIES))

total_fatalities_per_state<-ddply(fatalities_by_state, .(STATE), 
                             summarize, FATALITIES=sum(FATALITIES))

injuries_by_state_s<-ddply(injuries_by_state, .(STATE, EVTYPE), 
                             summarize, INJURIES=sum(INJURIES))

total_injuries_per_state<-ddply(injuries_by_state, .(STATE), 
                             summarize, INJURIES=sum(INJURIES))

```

And sort by decsending number of fatalities/injuries per state:

```{r}
fatalities_by_state_r<-arrange(fatalities_by_state_s, 
                               fatalities_by_state_s$STATE,
                               -fatalities_by_state_s$FATALITIES)
injuries_by_state_r<-arrange(injuries_by_state_s, 
                               injuries_by_state_s$STATE,
                               -injuries_by_state_s$INJURIES)

```

We then reduce the data to the top fatalities/injury causes in each state:

```{r}
top_fatalities_per_state<-ddply(fatalities_by_state_r, .(STATE), 
                                function(x)x[1,])
top_injuries_per_state<-ddply(injuries_by_state_r, .(STATE), 
                              function(x)x[1,])
```

**Top causes of Fatalities per State:**
```{r}
top_fatalities_per_state
```

**Top causes of Injuries per State:**
```{r}
top_injuries_per_state
```


Let's make preperations to display the Fatalities per State and Injuries per State:
```{r}
library(ggplot2)
library(maps)
library(datasets)

all_states<-map_data("state")
state_names<-data.frame(STATE=state.abb, region=tolower(state.name))

tmp_fat<-merge(total_fatalities_per_state, state_names)
map_data_fat<-merge(tmp_fat, all_states, by='region')

fp<-ggplot(map_data_fat, aes(map_id = region)) +
  geom_map(aes(fill = FATALITIES), map = all_states, color ="black") +
  expand_limits(x = all_states$long, y = all_states$lat) +
  theme(legend.position = "bottom",
        axis.ticks = element_blank(), 
        axis.title = element_blank(), 
        axis.text =  element_blank()) +
  scale_fill_gradient(low="white", high="red") +
  guides(fill = guide_colorbar(barwidth = 10, barheight = .5)) + 
  ggtitle("Fatalities")

tmp_inj<-merge(total_injuries_per_state, state_names)
map_data_inj<-merge(tmp_inj, all_states, by='region')

ip<-ggplot(map_data_inj, aes(map_id = region)) +
  geom_map(aes(fill = INJURIES), map = all_states, color ="black") +
  expand_limits(x = all_states$long, y = all_states$lat) +
  theme(legend.position = "bottom",
        axis.ticks = element_blank(), 
        axis.title = element_blank(), 
        axis.text =  element_blank()) +
  scale_fill_gradient(low="white", high="red") +
  guides(fill = guide_colorbar(barwidth = 10, barheight = .5)) + 
  ggtitle("Injuries")

```


```{r, fig.cap="Fatalities/Injuries per State due to weather events"}
subplot<-function(r,c){
  viewport(layout.pos.col=c, layout.pos.row=r)
}

vplayout<-function(r,c){
  grid.newpage()
  pushViewport(viewport(layout=grid.layout(r,c)))
}
vplayout(1,2)
plot(fp, vp=subplot(1,1))
plot(ip, vp=subplot(1,2))
```

### Economic Consequences. Summary statistics for the United States.




## Results













